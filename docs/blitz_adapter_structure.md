# Blitz Order Message Structure Document

##  Overview

Blitz uses a standardized `OrderLog` object to store and communicate order events, regardless of the broker. Adapter modules map broker-specific events into this standardized format.

There are two main flows:

- **From Blitz → Adapter → Broker**: Order requests from Blitz are sent to broker-specific formats via adapters.
- **From Broker → Adapter → Blitz**: Raw broker events are converted to Blitz `OrderLog`.

This  focuses on the message structure used in these flows.

---
# Blitz → Adapter → Broker Order Flow

## 1. Order Request: Blitz → Redis

When Blitz wants to place an order, it creates a **request payload** and publishes it to Redis.

The adapter subscribes to the Redis channel, receives the request, converts it into **broker-specific format**, and sends it to the broker.

You can see the full order request structure here:  
[Blitz Order Request Details](blitz_order_requests.md)

!!! Notes
    `request_id` must be unique for each request.
    Mandatory fields include `InstrumentId`, `Account`, `OrderType`, `OrderSide`, `OrderQuantity`, `OrderPrice`.
    Optional fields like `TIF`, `Product`, and `StopPrice` depend on the broker and order type.

---

## 2. Adapter → Broker

- The adapter maps Blitz fields to the broker API fields (for example, Zerodha).
- Sends the order to the broker API.
- Waits for execution response.

### Example Mapping (Blitz → Zerodha)

| Blitz Field      | Zerodha Field       |
|-----------------|-------------------|
| InstrumentId     | instrument_token  |
| Account          | account_id        |
| OrderType        | order_type        |
| OrderSide        | transaction_type  |
| OrderQuantity    | quantity          |
| OrderPrice       | price             |
| TIF              | validity          |
| Product          | product_type      |
| StopPrice        | trigger_price     |

---

## 3. Broker Response → Adapter → Blitz

- Broker responds with execution status (OPEN, FILLED, CANCELLED, REJECTED, etc.).
- Adapter converts broker response to Blitz `OrderLog`.
- Publishes the `OrderLog` back to Redis for Blitz to consume.

## 2. Blitz Standard OrderLog

All order messages in Blitz follow this structure:

| Field | Type | Description | Notes |
|------|------|-------------|------|
| Id | long | Internal database ID | Auto-generated |
| EntityId | string | Entity identifier | Owning organization |
| InstrumentId | ulong | Blitz instrument ID | Preferred for broker mapping |
| ExchangeSegment | enum | Exchange segment | NSE / BSE / NFO |
| InstrumentName | string | Trading symbol | e.g., RELIANCE |
| BlitzOrderId | ulong | Blitz order ID | Generated by Blitz |
| ExchangeOrderId | string | Broker-provided order ID | Primary key per exchange |
| ExecutionId | string | Broker execution ID | Often same as order_id |
| OrderType | enum | LIMIT / MARKET / SL / SL-M | Uppercase |
| OrderSide | enum | BUY / SELL | Uppercase |
| OrderStatus | enum | NEW / FILLED / CANCELLED / REJECTED | Normalized |
| OrderQuantity | int | Total order quantity | |
| OrderPrice | double | Order price | Required for LIMIT |
| OrderStopPrice | double | Stop-loss price | Optional |
| OrderTriggerPrice | double | Trigger price | For SL / SL-M |
| LastTradedQuantity | int | Last traded quantity | Adapter-filled |
| LastTradedPrice | double | Last traded price | Adapter-filled |
| LeavesQuantity | int | Quantity remaining | |
| TIF | enum | Time in Force | DAY / IOC |
| OrderDisclosedQuantity | int | Disclosed quantity | Optional |
| ExchangeTransactTime | long | Broker execution time | Epoch ms |
| AverageTradedPrice | double | Average executed price | 0 if none |
| IsOrderCompleted | bool | Terminal order state | |
| UserText | string | Raw broker message | JSON for debugging |
| ExecutionType | enum | MANUAL / AUTO / STRATEGY | |
| CorrelationOrderId | string | Cross-system order ID | Optional |

## Notes
- Only a subset of fields is required for order placement
- Broker-generated fields must not be set by callers
- All timestamps are epoch milliseconds
- `UserText` must always contain the raw broker payload

### Example JSON

```json
{
  "Id": 0,
  "EntityId": "",
  "InstrumentId": 3677697,
  "ExchangeSegment": "NSE",
  "InstrumentName": "IDEA",
  "BlitzOrderId": "260106151469089",
  "ExchangeOrderId": "1100000057118816",
  "ExecutionId": 0,
  "OrderType": "LIMIT",
  "OrderSide": "BUY",
  "OrderStatus": "NEW",
  "OrderQuantity": 1,
  "OrderPrice": 11.2,
  "OrderStopPrice": 0.0,
  "OrderTriggerPrice": 0.0,
  "LastTradedQuantity": 0,
  "LastTradedPrice": 0.0,
  "LeavesQuantity": 1,
  "TIF": "DAY",
  "OrderDisclosedQuantity": 0,
  "ExchangeTransactTime": "2026-01-06 13:36:53",
  "AverageTradedPrice": 0.0,
  "IsOrderCompleted": false,
  "UserText": "",
  "ExecutionType": "",
  "CorrelationOrderId": 0
}

```

---

## 3. Message Flow: Broker → Adapter → Blitz

**Steps:**

1. Adapter receives raw broker order JSON.
2. Adapter converts it into `OrderLog` using broker-specific mapping logic.
3. `UserText` stores the original broker message for reference.
4. Blitz consumes the standardized `OrderLog`.

### Example (ZERODHA RESPONSE)

**Broker Raw Data:**

```json
{
  "account_id": "RGZ539",
  "unfilled_quantity": 0,
  "checksum": "",
  "placed_by": "RGZ539",
  "order_id": "260106151960076",
  "exchange_order_id": "1100000078332318",
  "parent_order_id": null,
  "status": "OPEN",
  "status_message": null,
  "status_message_raw": null,
  "order_timestamp": "2026-01-06 15:22:19",
  "exchange_update_timestamp": "2026-01-06 15:22:19",
  "exchange_timestamp": "2026-01-06 15:22:19",
  "variety": "regular",
  "exchange": "NSE",
  "tradingsymbol": "IDEA",
  "instrument_token": 3677697,
  "order_type": "LIMIT",
  "transaction_type": "BUY",
  "validity": "DAY",
  "product": "MIS",
  "quantity": 1,
  "disclosed_quantity": 0,
  "price": 11.2,
  "trigger_price": 0,
  "average_price": 0,
  "filled_quantity": 0,
  "pending_quantity": 1,
  "cancelled_quantity": 0,
  "market_protection": 0,
  "meta": {},
  "tag": null,
  "guid": "205871X0NN8M6geL7A8"
}
```

**Adapter → Blitz:**

```json
{
  "EntityId": "",
  "InstrumentId": 3677697,
  "ExchangeSegment": "NSE",
  "InstrumentName": "IDEA",
  "BlitzOrderId": "260106151960076",
  "ExchangeOrderId": "1100000078332318",
  "ExecutionId": 0,
  "OrderType": "LIMIT",
  "OrderSide": "BUY",
  "OrderStatus": "NEW",
  "OrderQuantity": 1,
  "OrderPrice": 11.2,
  "OrderStopPrice": 0.0,
  "OrderTriggerPrice": 0.0,
  "LastTradedQuantity": 0,
  "LastTradedPrice": 0.0,
  "LeavesQuantity": 1,
  "TIF": "DAY",
  "OrderDisclosedQuantity": 0,
  "ExchangeTransactTime": "2026-01-06 15:22:19",
  "AverageTradedPrice": 0.0,
  "IsOrderCompleted": false,
  "UserText": "",
  "ExecutionType": "",
  "CorrelationOrderId": 0
}
```

---

## 4. Message Flow: Blitz → Adapter → Broker

When Blitz generates an order request:

1. Blitz sends an OrderLog-like request to the adapter.
2. Adapter converts Blitz fields to broker-specific API fields.
3. Adapter sends request to broker API.

**Mapping Example (Blitz → Zerodha):**

| Blitz Field | Zerodha API Field |
|-------------|-----------------|
| OrderSide   | transaction_type |
| OrderType   | order_type      |
| OrderQuantity | quantity       |
| OrderPrice  | price           |
| InstrumentId | instrument_token |
| Account     | account_id      |

---

## 5. Status Mapping

Blitz normalizes broker statuses:

| Broker Status | Blitz Status |
|---------------|-------------|
| OPEN          | NEW         |
| COMPLETE      | FILLED      |
| CANCELLED     | CANCELLED   |
| REJECTED      | REJECTED    |

Other statuses pass through as-is if unrecognized.

---

## 6. Timestamps

All timestamps in Blitz are stored as **epoch milliseconds**:

- `OrderGeneratedDateTime`: Order creation time
- `ExchangeTransactTime`: Broker execution time

Adapter must convert ISO format strings to epoch ms.

---

## 7. Notes for Adapters

- Always populate `UserText` with raw broker JSON.
- OrderLog fields should be fully filled where possible.
- Any missing numeric field defaults to `0`.
- Any missing string field defaults to `""` or `None`.

